<div class="rally-dialog">
  <!-- Header -->
  <div class="dialog-header">
    <h2>{{localize "FITGD.Dialogs.Rally.Title"}}</h2>
    <p class="momentum-display">{{localize "FITGD.Dialogs.Rally.CurrentMomentum"}}: <strong>{{momentum}}/10</strong></p>
    <p class="info-notice">
      {{{localize "FITGD.Dialogs.Rally.InfoNotice"}}}
    </p>
  </div>

  <!-- Selection Phase -->
  <div class="selection-phase">
    <!-- Action Selection Removed (Fixed to Spirit + Guile) -->

    <!-- Target Selection -->
    <div class="form-group">
      <label>{{localize "FITGD.Dialogs.Rally.TargetTeammate"}}</label>
      <select name="target" class="target-select">
        <option value="">{{localize "FITGD.Dialogs.Rally.SelectTeammatePlaceholder"}}</option>
        {{#each teammates}}
        <option value="{{this.id}}" {{#if (eq ../selectedTargetId this.id)}}selected{{/if}}>
          {{this.name}}
        </option>
        {{/each}}
      </select>
      {{#unless teammates.length}}
      <p class="no-teammates">{{localize "FITGD.Dialogs.Rally.NoTeammates"}}</p>
      {{/unless}}
    </div>

    <!-- Trait Selection -->
    {{#if selectedTargetId}}
    <div class="trait-selection">
      <h3>{{localize "FITGD.Dialogs.Rally.SelectTrait" name=targetCharacter.name}}</h3>
      <p class="help-text">{{localize "FITGD.Dialogs.Rally.SelectTraitHelp"}}</p>

      <div class="traits-grid">
        {{#each targetTraits}}
        <div
          class="trait-item {{#if (eq ../selectedTraitId this.id)}}selected{{/if}} {{#if this.disabled}}disabled-trait{{/if}}"
          data-trait-id="{{this.id}}">
          <div class="trait-name">{{this.name}}</div>
          <div class="trait-category">{{this.category}}</div>
          {{#if this.disabled}}
          <div class="trait-status">{{localize "FITGD.Dialogs.Rally.TraitDisabled"}}</div>
          {{/if}}
          {{#if this.description}}
          <div class="trait-description">{{this.description}}</div>
          {{/if}}
        </div>
        {{/each}}

        {{#unless targetTraits.length}}
        <p class="no-traits">{{localize "FITGD.Dialogs.Rally.NoTraits"}}</p>
        {{/unless}}
      </div>
    </div>
    {{/if}}

    <!-- Roll Info -->
    {{#if canRoll}}
    <div class="roll-info">
      <p><strong>{{localize "FITGD.Dialogs.Rally.ReadyToRoll"}}:</strong> {{actionDots}}d6 ({{localize
        "FITGD.Position.Controlled"}})</p>
      <p class="momentum-preview">
        {{localize "FITGD.Dialogs.Rally.PossibleGain"}}
        <span class="momentum-outcomes">{{localize "FITGD.Dialogs.Rally.GainTable"}}</span>
      </p>
    </div>
    {{/if}}
  </div>

  <!-- Action Buttons -->
  <div class="dialog-buttons">
    <button type="button" data-action="cancel" class="secondary">{{localize "FITGD.Global.Cancel"}}</button>
    <button type="button" data-action="roll" class="primary" {{#unless canRoll}}disabled{{/unless}}>
      {{localize "FITGD.Dialogs.Rally.BtnRoll" n=(or actionDots 2)}}
    </button>
  </div>
</div>