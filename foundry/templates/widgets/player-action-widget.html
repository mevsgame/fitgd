<div class="player-action-widget-wrapper {{#if sidePanelOpen}}has-side-panel side-panel-{{sidePanelPosition}}{{/if}}">
  {{!-- Side Panel (left position) --}}
  {{#if (and sidePanelOpen (eq sidePanelPosition 'left'))}}
  {{> side-panel
  sidePanelOpen=sidePanelOpen
  sidePanelPosition=sidePanelPosition
  sidePanelTitle=sidePanelTitle
  sidePanelMode=sidePanelMode
  sidePanelClocks=sidePanelClocks
  selectedHarmClockId=selectedHarmClock.id
  selectedCrewClockId=selectedCrewClock.id
  selectedSuccessClockId=selectedSuccessClock.id
  harmTargetCharacter=harmTargetCharacter
  characterId=character.id
  }}
  {{/if}}

  <div class="player-action-widget-container">
    <!-- Header -->
    <div class="widget-header">
      <h2>üéØ {{localize "FITGD.ActionWidget.YourTurn" name=character.name}}</h2>
    </div>

    <!-- ==================== DECISION PHASE ==================== -->
    {{#if isDecisionPhase}}
    <div class="widget-content decision-phase">

      {{#unless isGM}}
      <!-- ==================== PLAYER CONTROLS ==================== -->
      <div class="player-controls">
        <!-- Approach Selection -->
        <div class="form-group">
          <label>{{localize "FITGD.ActionWidget.PrimaryApproach"}}:</label>
          <select name="approach" class="approach-select">
            <option value="">{{localize "FITGD.ActionWidget.SelectApproach"}}</option>
            {{#each approaches}}
            <option value="{{this}}" {{#if (eq ../playerState.selectedApproach this)}}selected{{/if}}>
              {{localize (concat 'FITGD.Approaches.' (capitalize this))}} ({{lookup ../character.approaches this}}d)
            </option>
            {{/each}}
          </select>
        </div>

        <!-- Unified Secondary Approach/Equipment Selection -->
        {{#if playerState.selectedApproach}}
        <div class="form-group secondary-selection">
          <label>{{localize "FITGD.ActionWidget.SecondarySelection"}}:</label>
          <select name="secondary-approach" class="secondary-approach-select approach-select">
            <option value="">{{localize "FITGD.ActionWidget.SelectSecondary"}}</option>
            {{#each secondaryOptions}}
            {{#if (eq this.type 'approach')}}
            <option value="{{this.value}}" {{#if (eq ../selectedSecondaryId this.value)}}selected{{/if}}>
              {{localize (concat 'FITGD.Approaches.' (capitalize this.name))}} ({{this.bonus}})
            </option>
            {{else if (eq this.type 'separator')}}
            <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
            {{else if (eq this.type 'active')}}
            <option value="{{this.value}}" {{#if (eq ../selectedSecondaryId this.value)}}selected{{/if}}>
              üó°Ô∏è {{this.name}} {{#if this.bonus}}({{this.bonus}}){{/if}}{{#if this.locked}} üîí{{/if}}
            </option>
            {{else if (eq this.type 'consumable')}}
            <option value="{{this.value}}" {{#if (eq ../selectedSecondaryId this.value)}}selected{{/if}}>
              üíä {{this.name}} {{#if this.bonus}}({{this.bonus}}){{/if}}{{#if this.locked}} üîí{{/if}}
            </option>
            {{/if}}
            {{/each}}
          </select>
          <p class="help-text">{{localize "FITGD.ActionWidget.SecondaryHint"}}</p>
        </div>
        {{/if}}

        <!-- Position & Effect Display (Read-Only for Player) -->
        <div class="position-effect-display">
          <div class="position">
            {{localize "FITGD.ActionWidget.Position"}}: <span class="position-{{playerState.position}}">{{localize
              (concat 'FITGD.Position.' (capitalize (default playerState.position
              "risky")))}}</span>
          </div>
          <div class="effect">
            {{localize "FITGD.ActionWidget.Effect"}}: <span class="effect-level">{{localize (concat 'FITGD.Effect.'
              (capitalize (default playerState.effect "standard")))}}</span>
          </div>
        </div>

        <!-- Harm Clocks Display -->
        {{#if harmClocks.length}}
        <div class="harm-clocks-display">
          <h4>{{localize "FITGD.ActionWidget.HarmClocks"}}:</h4>
          <div class="clocks-list">
            {{#each harmClocks}}
            <div class="clock-item">
              <span class="clock-name">{{this.subtype}}:</span>
              <span class="clock-segments">{{this.segments}}/{{this.maxSegments}}</span>
            </div>
            {{/each}}
          </div>
        </div>
        {{/if}}

        <!-- Momentum Replenishment -->
        <div class="momentum-replenishment">
          <h4>{{localize "FITGD.ActionWidget.GetMomentum"}}:</h4>
          <div class="replenishment-row">
            <!-- Momentum Track (Compact) -->
            <div class="momentum-track-compact">
              {{#times 10}}
              <span class="momentum-box-compact {{#if (lt this ../momentum)}}filled{{/if}}">
                {{#if (eq this ../momentum)}}‚ñ∂{{/if}}
              </span>
              {{/times}}
            </div>
            <!-- Replenishment Buttons -->
            <div class="replenishment-buttons">
              <button type="button" data-action="rally" {{#unless canRally}}disabled{{/unless}}>
                {{localize "FITGD.Buttons.Rally"}}
              </button>
              <button type="button" data-action="lean-into-trait" {{#unless
                character.traits.length}}disabled{{/unless}}>
                {{localize "FITGD.Traits.LeanInto"}}
              </button>
            </div>
          </div>
        </div>

        <!-- Action Modifiers Buttons -->
        <div class="prepare-actions">
          <h4>{{localize "FITGD.ActionWidget.SpendMomentum"}}:</h4>
          <div class="button-row">
            <button type="button" data-action="use-trait" class="{{#if playerState.traitTransaction}}active{{/if}}"
              {{#if (and (eq playerState.position "controlled" ) (lt momentum 1))}}disabled{{/if}}>
              {{localize "FITGD.ActionWidget.UseTrait"}}
            </button>
            <button type="button" data-action="push-die"
              class="{{#if (and playerState.pushed (eq playerState.pushType 'extra-die'))}}active{{/if}}" {{#if (lt
              momentum 1)}}disabled{{/if}}>
              {{localize "FITGD.ActionWidget.PushDie"}}
            </button>
            <button type="button" data-action="push-effect"
              class="{{#if (and playerState.pushed (eq playerState.pushType 'improved-effect'))}}active{{/if}}" {{#if
              (lt momentum 1)}}disabled{{/if}}>
              {{localize "FITGD.ActionWidget.PushEffect"}}
            </button>
          </div>
        </div>
      </div>
      {{/unless}}

      {{#if isGM}}
      <!-- ==================== GM CONTROLS ==================== -->
      <div class="gm-controls">
        <h4>{{localize "FITGD.ActionWidget.GMControls"}}</h4>
        <div class="form-group">
          <label>{{localize "FITGD.ActionWidget.SetPosition"}}</label>
          <select name="position" class="position-select">
            <option value="controlled" {{#if (eq playerState.position "controlled" )}}selected{{/if}}>{{localize
              "FITGD.Position.Controlled"}}
            </option>
            <option value="risky" {{#if (eq (default playerState.position "risky" ) "risky" )}}selected{{/if}}>
              {{localize "FITGD.Position.Risky"}}
            </option>
            <option value="desperate" {{#if (eq playerState.position "desperate" )}}selected{{/if}}>{{localize
              "FITGD.Position.Desperate"}}</option>
            <option value="impossible" {{#if (eq playerState.position "impossible" )}}selected{{/if}}>{{localize
              "FITGD.Position.Impossible"}}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>{{localize "FITGD.ActionWidget.SetEffect"}}</label>
          <select name="effect" class="effect-select">
            <option value="limited" {{#if (eq playerState.effect "limited" )}}selected{{/if}}>{{localize
              "FITGD.Effect.Limited"}}</option>
            <option value="standard" {{#if (eq (default playerState.effect "standard" ) "standard" )}}selected{{/if}}>
              {{localize "FITGD.Effect.Standard"}}</option>
            <option value="great" {{#if (eq playerState.effect "great" )}}selected{{/if}}>{{localize
              "FITGD.Effect.Great"}}</option>
            <option value="spectacular" {{#if (eq playerState.effect "spectacular" )}}selected{{/if}}>{{localize
              "FITGD.Effect.Spectacular"}}
          </select>
        </div>

        <!-- Dice Probabilities Display -->
        {{#if dicePool}}
        <div class="dice-probabilities">
          <h4>{{localize "FITGD.ActionWidget.Probabilities" dice=dicePool}}</h4>
          <div class="probability-rows">
            <div class="probability-row critical">
              <span class="prob-label">{{localize "FITGD.ActionWidget.ProbCritical"}}</span>
              <span class="prob-value">{{diceProbabilities.critical}}%</span>
            </div>
            <div class="probability-row success">
              <span class="prob-label">{{localize "FITGD.ActionWidget.ProbSuccess"}}</span>
              <span class="prob-value">{{diceProbabilities.success}}%</span>
            </div>
            <div class="probability-row partial">
              <span class="prob-label">{{localize "FITGD.ActionWidget.ProbPartial"}}</span>
              <span class="prob-value">{{diceProbabilities.partial}}%</span>
            </div>
            <div class="probability-row failure">
              <span class="prob-label">{{localize "FITGD.ActionWidget.ProbFailure"}}</span>
              <span class="prob-value">{{diceProbabilities.failure}}%</span>
            </div>
          </div>
        </div>
        {{/if}}

        <!-- GM Passive Equipment Grid -->
        {{> gm-passive-grid passiveEquipment=passiveEquipment selectedPassiveId=selectedPassiveId isGM=true}}
      </div>
      {{/if}}

      <!-- ==================== CURRENT PLAN (SHARED BY GM AND PLAYER) ==================== -->
      {{#if playerState.selectedApproach}}
      <div class="action-plan-preview">
        <h4>{{localize "FITGD.ActionWidget.CurrentPlan"}}</h4>
        <div class="plan-box">
          <!-- Primary + Secondary + Passive summary -->
          <div class="plan-line action-composition">
            <strong>{{localize "FITGD.ActionWidget.Action"}}</strong>
            {{localize (concat 'FITGD.Approaches.' (capitalize playerState.selectedApproach))}}
            {{#if selectedSecondaryName}}
            + {{selectedSecondaryName}}
            {{/if}}
            {{#if approvedPassiveEquipment}}
            + {{approvedPassiveEquipment.name}}
            {{/if}}
            = <strong>{{dicePool}}d</strong>
          </div>

          <!-- Position with Equipment + Trait Modifiers -->
          <div class="plan-line">
            {{localize "FITGD.ActionWidget.Position"}} {{localize (concat 'FITGD.Position.' (capitalize (default
            playerState.position "risky")))}}
            {{#if (ne improvedPosition playerState.position)}}
            ‚Üí <span
              class="{{#if (or (ne equipmentModifiedPosition playerState.position) playerState.traitTransaction)}}improved{{/if}}">{{localize
              (concat 'FITGD.Position.' (capitalize improvedPosition))}}</span>
            {{/if}}
          </div>

          <!-- Effect with Equipment + Push Modifiers -->
          <div class="plan-line">
            {{localize "FITGD.ActionWidget.Effect"}} {{localize (concat 'FITGD.Effect.' (capitalize (default
            playerState.effect "standard")))}}
            {{#if (ne improvedEffect playerState.effect)}}
            ‚Üí <span
              class="{{#if (or (ne equipmentModifiedEffect playerState.effect) (and playerState.pushed (eq playerState.pushType 'improved-effect')))}}improved{{/if}}">{{localize
              (concat 'FITGD.Effect.' (capitalize improvedEffect))}}</span>
            {{/if}}
          </div>

          {{#if improvements.length}}
          <div class="plan-line improvements">
            <strong>{{localize "FITGD.ActionWidget.Improvements"}}</strong>
            <ul>
              {{#each improvements}}
              <li>{{this}}</li>
              {{/each}}
            </ul>
          </div>
          {{/if}}

          {{#if momentumCost}}
          <div class="plan-line momentum-cost">
            {{localize "FITGD.ActionWidget.MomentumCost"}} -{{momentumCost}}M ({{momentum}}‚Üí{{subtract momentum
            momentumCost}})
          </div>
          {{/if}}
        </div>
      </div>
      {{else}}
      <p class="waiting">{{localize "FITGD.ActionWidget.WaitingForPlayer"}}</p>
      {{/if}}

      <!-- Action Buttons (different for GM vs Player) -->
      <div class="action-buttons">
        {{#if isGM}}
        <!-- GM sees "Accept Roll" button -->
        <button type="button" data-action="approve-roll" class="primary {{#if playerState.gmApproved}}approved{{/if}}"
          {{#unless playerState.selectedApproach}}disabled{{/unless}}>
          {{#if playerState.gmApproved}}{{localize "FITGD.ActionWidget.RollApproved"}}{{else}}{{localize
          "FITGD.ActionWidget.AcceptRoll"}}{{/if}}
        </button>
        {{else}}
        <!-- Player sees "Roll" button (disabled until GM approves) -->
        <button type="button" data-action="cancel" class="secondary">{{localize "FITGD.Global.Cancel"}}</button>
        <button type="button" data-action="roll" class="primary {{#if playerState.gmApproved}}approved{{/if}}" {{#unless
          (and playerState.selectedApproach playerState.gmApproved)}}disabled{{/unless}}>
          {{#if playerState.gmApproved}}{{localize "FITGD.ActionWidget.RollAction"}}{{else}}{{localize
          "FITGD.ActionWidget.WaitingForGM"}}{{/if}}
        </button>
        {{/if}}
      </div>
    </div>
    {{/if}}

    <!-- ==================== ROLLING ==================== -->
    {{#if isRolling}}
    <div class="widget-content rolling">
      <h3>{{localize "FITGD.ActionWidget.Rolling"}}</h3>
      <div class="dice-animation">
        <!-- Dice animation would go here -->
        <p>{{localize "FITGD.ActionWidget.RollingDice" dice=playerState.dicePool}}</p>
      </div>
    </div>
    {{/if}}

    <!-- ==================== STIMS ROLLING ==================== -->
    {{#if isStimsRolling}}
    <div class="widget-content stims-rolling">
      <h3>{{localize "FITGD.ActionWidget.StimsActivated"}}</h3>
      <div class="stims-animation">
        <p>{{localize "FITGD.ActionWidget.StimsAdvancing"}}</p>
        <p>{{localize "FITGD.ActionWidget.StimsReturning"}}</p>
      </div>
    </div>
    {{/if}}

    <!-- ==================== STIMS LOCKED ==================== -->
    {{#if isStimsLocked}}
    <div class="widget-content stims-locked">
      <h2 class="stims-error">{{localize "FITGD.ActionWidget.StimsLocked"}}</h2>
      <div class="stims-locked-message">
        <p>{{localize "FITGD.ActionWidget.StimsLockedAddiction"}}</p>
        <p>{{localize "FITGD.ActionWidget.StimsLockedUnavailable"}}</p>
        <p class="fade-text">{{localize "FITGD.ActionWidget.StimsReturningConsequence"}}</p>
      </div>
    </div>
    {{/if}}

    <!-- ==================== SUCCESS ==================== -->
    {{#if isSuccess}}
    <div class="widget-content success">
      <div class="roll-outcome">
        {{#if (eq playerState.outcome "critical")}}
        <h2 class="outcome-critical">{{localize "FITGD.ActionWidget.OutcomeCritical"}}</h2>
        {{else if (eq playerState.outcome "partial")}}
        <h2 class="outcome-partial">{{localize "FITGD.ActionWidget.OutcomePartial"}}</h2>
        {{else}}
        <h2 class="outcome-success">{{localize "FITGD.ActionWidget.OutcomeSuccess"}}</h2>
        {{/if}}
        <div class="dice-display">
          <div class="dice-result">{{localize "FITGD.ActionWidget.DiceResult" max=(max playerState.rollResult)}}</div>
          <div class="dice-rolled">{{localize "FITGD.ActionWidget.DiceRolled" results=(join playerState.rollResult ",
            ")}}</div>
        </div>
      </div>

      {{#unless isGM}}
      <!-- Player View: Simple Success Message -->
      {{#if (eq playerState.outcome "partial")}}
      <p class="success-message">{{localize "FITGD.ActionWidget.PartialMessage"}}</p>
      {{else}}
      <p class="success-message">{{localize "FITGD.ActionWidget.FullSuccessMessage"}}</p>
      {{/if}}
      <p class="fade-text">{{localize "FITGD.ActionWidget.CloseReady"}}</p>
      {{/unless}}

      {{#if isGM}}
      <!-- GM View: Optional Clock Advancement -->
      {{#unless selectedSuccessClock}}
      {{#if (eq playerState.outcome "partial")}}
      <p class="success-message">{{localize "FITGD.ActionWidget.GMPartialSuccess"}}</p>
      {{else}}
      <p class="success-message">{{localize "FITGD.ActionWidget.GMFullSuccess"}}</p>
      {{/if}}
      {{else}}
      <!-- Highlight Selected Clock (Plan Box Style) - REPLACES TEXT -->
      <div class="action-plan-preview" style="margin-bottom: 15px;">
        <h4>{{localize "FITGD.ActionWidget.SuccessPlan"}}</h4>
        <div class="plan-box" style="border-left: 4px solid var(--color-success);">
          <div class="plan-line action-composition">
            <strong>{{localize "FITGD.ActionWidget.Operation"}}</strong>
            {{#if (eq successClockOperation 'add')}}{{localize "FITGD.ActionWidget.AdvanceProgress"}}{{else}}{{localize
            "FITGD.ActionWidget.ReduceThreat"}}{{/if}}
          </div>

          <div class="plan-line">
            <strong>{{localize "FITGD.ActionWidget.TargetClock"}}</strong> {{selectedSuccessClock.subtype}}
          </div>

          <div class="plan-line">
            <strong>{{localize "FITGD.ActionWidget.Segments"}}</strong>
            <span class="badge" style="background: var(--color-success); color: white;">
              {{#if calculatedSuccessClockSegments}}+{{calculatedSuccessClockSegments}}{{else}}?{{/if}}
            </span>
          </div>
        </div>
      </div>
      {{/unless}}

      <div class="gm-consequence-config">
        <h4>{{localize "FITGD.ActionWidget.OptionalClockAdvancement"}}</h4>


        <!-- Success Clock Configuration -->
        <div class="success-clock-config">
          <!-- Operation Selection Buttons - these now open sidebar -->
          <div class="operation-buttons">
            <button type="button" data-action="select-success-clock-add"
              class="operation-btn {{#if (eq successClockOperation 'add')}}active{{/if}}">
              ‚ñ≤ {{localize "FITGD.ActionWidget.AdvanceProgress"}}
            </button>
            <button type="button" data-action="select-success-clock-reduce"
              class="operation-btn {{#if (eq successClockOperation 'reduce')}}active{{/if}}">
              ‚ñº {{localize "FITGD.ActionWidget.ReduceThreat"}}
            </button>
          </div>
        </div>

        <!-- Accept Button -->
        <div class="action-buttons">
          <button type="button" data-action="accept-success-clock" class="primary">
            {{#if selectedSuccessClock}}
            {{localize "FITGD.ActionWidget.ApplyClock"}}
            {{else}}
            ‚úì {{localize "FITGD.Global.Close"}}
            {{/if}}
          </button>
        </div>
      </div>

      {{/if}}
    </div>
    {{/if}}

    <!-- ==================== GM RESOLVING CONSEQUENCE ==================== -->
    {{#if isGMResolvingConsequence}}
    <div class="widget-content gm-resolving-consequence">
      <div class="roll-outcome">
        {{#if (eq playerState.outcome "success")}}
        <h2 class="outcome-success">{{localize "FITGD.ActionWidget.OutcomeGMSuccess"}}</h2>
        {{else if (eq playerState.outcome "critical")}}
        <h2 class="outcome-critical">{{localize "FITGD.ActionWidget.OutcomeGMCritical"}}</h2>
        {{else if (eq playerState.outcome "partial")}}
        <h2 class="outcome-partial">{{localize "FITGD.ActionWidget.OutcomeGMPartial"}}</h2>
        {{else}}
        <h2 class="outcome-failure">{{localize "FITGD.ActionWidget.OutcomeGMFailure"}}</h2>
        {{/if}}
        <div class="dice-display">
          <div class="dice-result">{{localize "FITGD.ActionWidget.DiceResult" max=(max playerState.rollResult)}}</div>
          <div class="dice-rolled">{{localize "FITGD.ActionWidget.DiceRolled" results=(join playerState.rollResult ",
            ")}}</div>
        </div>
      </div>

      <!-- ==================== CURRENT CONSEQUENCE PLAN (SHARED BY GM AND PLAYER) ==================== -->
      {{#if consequenceTransaction}}
      <div class="consequence-plan-preview">
        <h4>{{localize "FITGD.ActionWidget.CurrentConsequencePlan"}}</h4>
        <div class="plan-box">
          <div class="plan-line">
            <strong>{{localize "FITGD.ActionWidget.Type"}}</strong>
            {{#if (eq consequenceTransaction.consequenceType 'harm')}}
            {{localize "FITGD.ActionWidget.ConsequenceHarm"}}
            {{else}}
            {{localize "FITGD.ActionWidget.ConsequenceClock"}}
            {{/if}}
          </div>

          {{#if (eq consequenceTransaction.consequenceType 'harm')}}
          {{#if harmTargetCharacter}}
          <div class="plan-line">
            <strong>{{localize "FITGD.ActionWidget.Target"}}</strong> {{harmTargetCharacter.name}}
            {{#if (eq harmTargetCharacter.id character.id)}}
            <span class="label">({{localize "FITGD.ActionWidget.Acting"}})</span>
            {{else}}
            <span class="label protect">({{localize "FITGD.ActionWidget.Protected"}})</span>
            {{/if}}
          </div>
          {{/if}}

          {{#if selectedHarmClock}}
          <div class="plan-line">
            <strong>{{localize "FITGD.ActionWidget.Clock"}}</strong> {{selectedHarmClock.subtype}}
            ({{selectedHarmClock.segments}}/{{selectedHarmClock.maxSegments}})
          </div>
          {{/if}}

          {{#if effectivePosition}}
          <div class="plan-line highlight">
            <strong>{{localize "FITGD.Harm.Title"}}</strong> +{{calculatedHarmSegments}} {{localize
            "FITGD.ActionWidget.Segments"}}
            <span class="calculation">({{uppercase effectivePosition}}/{{uppercase effectiveEffect}})</span>
          </div>
          {{/if}}
          {{/if}}

          {{#if (eq consequenceTransaction.consequenceType 'crew-clock')}}
          {{#if selectedCrewClock}}
          <div class="plan-line">
            <strong>{{localize "FITGD.ActionWidget.Clock"}}</strong> {{selectedCrewClock.subtype}}
            ({{selectedCrewClock.segments}}/{{selectedCrewClock.maxSegments}})
          </div>
          <div class="plan-line highlight">
            <strong>{{localize "FITGD.ActionWidget.Advance"}}</strong> +{{calculatedHarmSegments}} {{localize
            "FITGD.ActionWidget.Segments"}}
            <span class="calculation">({{uppercase effectivePosition}})</span>
          </div>
          {{/if}}
          {{/if}}

          {{#if calculatedMomentumGain}}
          <div class="plan-line momentum-gain">
            <strong>{{localize "FITGD.ActionWidget.MomentumGain"}}</strong> <span
              class="positive">+{{calculatedMomentumGain}}M</span>
          </div>
          {{/if}}
        </div>
      </div>
      {{else}}
      <p class="waiting">‚è≥ {{#if isGM}}{{localize "FITGD.ActionWidget.SelectConsequenceType"}}{{else}}{{localize
        "FITGD.ActionWidget.WaitingForGMConsequence"}}{{/if}}</p>
      {{/if}}

      {{#if isGM}}
      <!-- ==================== GM CONSEQUENCE CONFIGURATION ==================== -->
      <div class="gm-consequence-config">
        {{#if (or (eq playerState.outcome 'success') (eq playerState.outcome 'critical'))}}
        <h4>{{localize "FITGD.ActionWidget.OptionalClockAdvancement"}}</h4>

        <!-- Success Clock Configuration -->
        <div class="success-clock-config">
          <!-- Operation Selection Buttons - these now open sidebar -->
          <div class="operation-buttons">
            <button type="button" data-action="select-success-clock-add"
              class="operation-btn {{#if (eq successClockOperation 'add')}}active{{/if}}">
              {{localize "FITGD.ActionWidget.AdvanceProgress"}}
            </button>
            <button type="button" data-action="select-success-clock-reduce"
              class="operation-btn {{#if (eq successClockOperation 'reduce')}}active{{/if}}">
              {{localize "FITGD.ActionWidget.ReduceThreat"}}
            </button>
          </div>

          <!-- Skip Button -->
          <button type="button" data-action="skip-success-clock" class="secondary-btn">
            {{localize "FITGD.ActionWidget.SkipClockAdvancement"}}
          </button>
        </div>
        {{else}}
        <h4>{{localize "FITGD.ActionWidget.ConfigureConsequence"}}</h4>

        <!-- Consequence Type Toggles -->
        <div class="consequence-type-toggles">
          <button type="button" data-action="select-consequence-type" data-type="harm"
            class="consequence-type-btn {{#if (eq consequenceTransaction.consequenceType 'harm')}}active{{/if}}">
            {{localize "FITGD.ActionWidget.ConsequenceHarm"}}
          </button>
          <button type="button" data-action="select-consequence-type" data-type="crew-clock"
            class="consequence-type-btn {{#if (eq consequenceTransaction.consequenceType 'crew-clock')}}active{{/if}}">
            {{localize "FITGD.ActionWidget.ConsequenceClock"}}
          </button>
        </div>
        {{/if}}

        <!-- Harm Configuration (shown when harm type selected) -->
        {{#if (eq consequenceTransaction.consequenceType 'harm')}}
        <div class="harm-config">
          {{!-- Only show buttons to open sidebar if nothing selected yet --}}
          {{#unless (and harmTargetCharacter selectedHarmClock)}}
          {{#unless sidePanelOpen}}
          <button type="button" data-action="select-harm-clock" class="config-action-btn">
            <i class="fas fa-cog"></i>
            {{#if harmTargetCharacter}}{{localize "FITGD.ActionWidget.SelectHarmClock"}}{{else}}{{localize
            "FITGD.ActionWidget.ConfigureHarm"}}{{/if}}
          </button>
          {{/unless}}
          {{/unless}}
        </div>
        {{/if}}

        <!-- Crew Clock Configuration (shown when crew-clock type selected) -->
        {{#if (eq consequenceTransaction.consequenceType 'crew-clock')}}
        <div class="crew-clock-config">
          {{!-- Only show button if no clock selected and sidebar not open --}}
          {{#unless selectedCrewClock}}
          {{#unless sidePanelOpen}}
          <button type="button" data-action="select-crew-clock" class="config-action-btn">
            <i class="fas fa-cog"></i> {{localize "FITGD.ActionWidget.SelectCrewClock"}}
          </button>
          {{/unless}}
          {{/unless}}
        </div>
        {{/if}}
      </div>
      {{/if}}

      {{#unless isGM}}
      <!-- ==================== PLAYER ACTIONS ==================== -->
      <div class="player-consequence-actions">
        <h4>{{localize "FITGD.ActionWidget.YourOptions"}}</h4>
        <div class="player-action-buttons">
          <!-- Player can use stims to reroll (unless locked by addiction) -->
          <button type="button" data-action="use-stims-gm-phase" class="stims-btn" {{#if (or
            playerState.stimsUsedThisAction stimsLocked)}}disabled{{/if}}>
            {{#if stimsLocked}}
            {{localize "FITGD.ActionWidget.StimsLockedAddictionShort"}}
            {{else if playerState.stimsUsedThisAction}}
            {{localize "FITGD.ActionWidget.StimsAlreadyUsed"}}
            {{else}}
            {{localize "FITGD.ActionWidget.UseStimsReroll"}}
            {{/if}}
          </button>

          {{!-- DEFENSIVE SUCCESS TOGGLE (Player Only) --}}
          {{#if (and defensiveSuccessValues.available (not isGM))}}
          <div class="plan-line defensive-success-toggle">
            <button type="button" data-action="toggle-defensive-success" data-enabled="{{not useDefensiveSuccess}}"
              class="toggle-btn {{#if useDefensiveSuccess}}defensive-active{{/if}}">
              {{#if useDefensiveSuccess}}
              ‚úì {{localize "FITGD.ActionWidget.DefensiveSuccess"}}
              {{else}}
              ‚úó {{localize "FITGD.ActionWidget.DefensiveSuccess"}}
              {{/if}}
            </button>
          </div>
          {{/if}}

          <!-- Player approves GM's configured consequence -->
          <button type="button" data-action="approve-consequence" class="primary" {{#unless
            consequenceConfigured}}disabled{{/unless}}>
            {{#if consequenceConfigured}}‚úì {{localize "FITGD.ActionWidget.AcceptConsequence"}}{{else}}‚è≥ {{localize
            "FITGD.ActionWidget.WaitingForGM"}}{{/if}}
          </button>
        </div>
      </div>
      {{/unless}}
    </div>
    {{/if}}
  </div>

  {{!-- Side Panel (right position) --}}
  {{#if (and sidePanelOpen (eq sidePanelPosition 'right'))}}
  {{> side-panel
  sidePanelOpen=sidePanelOpen
  sidePanelPosition=sidePanelPosition
  sidePanelTitle=sidePanelTitle
  sidePanelMode=sidePanelMode
  sidePanelClocks=sidePanelClocks
  selectedHarmClockId=selectedHarmClock.id
  selectedCrewClockId=selectedCrewClock.id
  selectedSuccessClockId=selectedSuccessClock.id
  harmTargetCharacter=harmTargetCharacter
  characterId=character.id
  }}
  {{/if}}
</div>