<div class="player-action-widget-container">
  <!-- Header -->
  <div class="widget-header">
    <h2>üéØ {{character.name}} - YOUR TURN</h2>
  </div>

  <!-- ==================== DECISION PHASE ==================== -->
  {{#if isDecisionPhase}}
  <div class="widget-content decision-phase">

    {{#unless isGM}}
    <!-- ==================== PLAYER CONTROLS ==================== -->
    <div class="player-controls">
      <!-- Action Selection -->
      <div class="form-group">
        <label>Action:</label>
        <select name="action" class="action-select">
          <option value="">-- Select Action --</option>
          {{#each actions}}
          <option value="{{this}}" {{#if (eq ../playerState.selectedAction this)}}selected{{/if}}>
            {{capitalize this}} ({{lookup ../character.actionDots this}}d)
          </option>
          {{/each}}
        </select>
      </div>

      <!-- Position & Effect Display (Read-Only for Player) -->
      <div class="position-effect-display">
        <div class="position">
          Position: <span class="position-{{playerState.position}}">{{uppercase (default playerState.position "RISKY")}}</span>
        </div>
        <div class="effect">
          Effect: <span class="effect-level">{{uppercase (default playerState.effect "STANDARD")}}</span>
        </div>
        <p class="gm-set-note">(Set by GM)</p>
      </div>

      <!-- Harm Clocks Display -->
      {{#if harmClocks.length}}
      <div class="harm-clocks-display">
        <h4>üíî HARM CLOCKS:</h4>
        <div class="clocks-list">
          {{#each harmClocks}}
          <div class="clock-item">
            <span class="clock-name">{{this.subtype}}:</span>
            <span class="clock-segments">{{this.segments}}/{{this.maxSegments}}</span>
          </div>
          {{/each}}
        </div>
      </div>
      {{/if}}

      <!-- Action Modifiers Buttons -->
      <div class="prepare-actions">
        <h4>ACTION MODIFIERS:</h4>
        <div class="button-row">
          <button type="button" data-action="rally" {{#unless canRally}}disabled{{/unless}}>
            Rally
          </button>
          <button type="button" data-action="use-trait" class="{{#if playerState.traitTransaction}}active{{/if}}" {{#if (and (eq playerState.position "controlled") (lt momentum 1))}}disabled{{/if}}>
            Use Trait
          </button>
          <button type="button" data-action="equipment">
            Equipment
          </button>
          <button type="button" data-action="push-die" class="{{#if (and playerState.pushed (eq playerState.pushType 'extra-die'))}}active{{/if}}" {{#if (lt momentum 1)}}disabled{{/if}}>
            Push (+1d)
          </button>
          <button type="button" data-action="push-effect" class="{{#if (and playerState.pushed (eq playerState.pushType 'improved-effect'))}}active{{/if}}" {{#if (lt momentum 1)}}disabled{{/if}}>
            Push (Effect)
          </button>
        </div>
      </div>
    </div>
    {{/unless}}

    {{#if isGM}}
    <!-- ==================== GM CONTROLS ==================== -->
    <div class="gm-controls">
      <h4>‚öôÔ∏è GM Controls:</h4>
      <div class="form-group">
        <label>Set Position:</label>
        <select name="position" class="position-select">
          <option value="controlled" {{#if (eq playerState.position "controlled")}}selected{{/if}}>Controlled</option>
          <option value="risky" {{#if (eq (default playerState.position "risky") "risky")}}selected{{/if}}>Risky</option>
          <option value="desperate" {{#if (eq playerState.position "desperate")}}selected{{/if}}>Desperate</option>
        </select>
      </div>
      <div class="form-group">
        <label>Set Effect:</label>
        <select name="effect" class="effect-select">
          <option value="limited" {{#if (eq playerState.effect "limited")}}selected{{/if}}>Limited</option>
          <option value="standard" {{#if (eq (default playerState.effect "standard") "standard")}}selected{{/if}}>Standard</option>
          <option value="great" {{#if (eq playerState.effect "great")}}selected{{/if}}>Great</option>
        </select>
      </div>
    </div>
    {{/if}}

    <!-- ==================== CURRENT PLAN (SHARED BY GM AND PLAYER) ==================== -->
    {{#if playerState.selectedAction}}
    <div class="action-plan-preview">
      <h4>üìã Current Plan:</h4>
      <div class="plan-box">
        <div class="plan-line">Action: {{capitalize playerState.selectedAction}} ({{lookup character.actionDots playerState.selectedAction}}d)</div>
        <div class="plan-line">Position: {{uppercase (default playerState.position "risky")}} ‚Üí <span class="{{#if playerState.traitTransaction}}improved{{/if}}">{{uppercase improvedPosition}}</span></div>
        <div class="plan-line">Effect: {{uppercase (default playerState.effect "standard")}} ‚Üí <span class="{{#if (and playerState.pushed (eq playerState.pushType 'improved-effect'))}}improved{{/if}}">{{uppercase improvedEffect}}</span></div>

        {{#if improvements.length}}
        <div class="plan-line improvements">
          <strong>Improvements:</strong>
          <ul>
            {{#each improvements}}
            <li>{{this}}</li>
            {{/each}}
          </ul>
        </div>
        {{/if}}

        <div class="plan-line total">
          <strong>TOTAL: {{dicePool}}d6</strong>
        </div>
        {{#if momentumCost}}
        <div class="plan-line momentum-cost">
          Momentum Cost: -{{momentumCost}}M ({{momentum}}‚Üí{{subtract momentum momentumCost}})
        </div>
        {{/if}}
      </div>
    </div>
    {{else}}
    <p class="waiting">‚è≥ Waiting for player to select an action...</p>
    {{/if}}

    <!-- Action Buttons (different for GM vs Player) -->
    <div class="action-buttons">
      {{#if isGM}}
      <!-- GM sees "Accept Roll" button -->
      <button type="button" data-action="approve-roll" class="primary {{#if playerState.gmApproved}}approved{{/if}}" {{#unless playerState.selectedAction}}disabled{{/unless}}>
        {{#if playerState.gmApproved}}‚úÖ Roll Approved{{else}}‚úì Accept Roll{{/if}}
      </button>
      {{else}}
      <!-- Player sees "Roll" button (disabled until GM approves) -->
      <button type="button" data-action="cancel" class="secondary">Cancel</button>
      <button type="button" data-action="roll" class="primary {{#if playerState.gmApproved}}approved{{/if}}" {{#unless (and playerState.selectedAction playerState.gmApproved)}}disabled{{/unless}}>
        {{#if playerState.gmApproved}}üé≤ ROLL ACTION{{else}}‚è≥ Waiting for GM Approval{{/if}}
      </button>
      {{/if}}
    </div>
  </div>
  {{/if}}

  <!-- ==================== ROLLING ==================== -->
  {{#if isRolling}}
  <div class="widget-content rolling">
    <h3>üé≤ ROLLING...</h3>
    <div class="dice-animation">
      <!-- Dice animation would go here -->
      <p>Rolling {{playerState.dicePool}}d6...</p>
    </div>
  </div>
  {{/if}}

  <!-- ==================== SUCCESS ==================== -->
  {{#if isSuccess}}
  <div class="widget-content success">
    <div class="roll-outcome">
      {{#if (eq playerState.outcome "critical")}}
      <h2 class="outcome-critical">‚ú® CRITICAL SUCCESS! ‚ú®</h2>
      {{else}}
      <h2 class="outcome-success">‚úÖ FULL SUCCESS</h2>
      {{/if}}
      <div class="dice-display">
        <div class="dice-result">Highest: {{max playerState.rollResult}}</div>
        <div class="dice-rolled">Rolled: {{join playerState.rollResult ", "}}</div>
      </div>
    </div>
    <p class="success-message">You succeed without complications!</p>
    <p class="fade-text">Ending turn...</p>
  </div>
  {{/if}}

  <!-- ==================== CONSEQUENCE CHOICE ==================== -->
  {{#if isConsequenceChoice}}
  <div class="widget-content consequence-choice">
    <div class="roll-outcome">
      {{#if (eq playerState.outcome "partial")}}
      <h2 class="outcome-partial">‚ö†Ô∏è PARTIAL SUCCESS</h2>
      {{else}}
      <h2 class="outcome-failure">‚ùå FAILURE</h2>
      {{/if}}
      <div class="dice-display">
        <div class="dice-result">Highest: {{max playerState.rollResult}}</div>
        <div class="dice-rolled">Rolled: {{join playerState.rollResult ", "}}</div>
      </div>
    </div>
    <p class="consequence-message">You face consequences...</p>

    <div class="action-buttons">
      <button type="button" data-action="use-stims">Use Stims & Reroll</button>
      <button type="button" data-action="accept-consequences" class="primary">Accept Consequences</button>
    </div>
  </div>
  {{/if}}

  <!-- ==================== CONSEQUENCE RESOLUTION ==================== -->
  {{#if isConsequenceResolution}}
  <div class="widget-content consequence-resolution">
    <h3>‚ö†Ô∏è CONSEQUENCE ({{uppercase playerState.position}} Position)</h3>

    <div class="consequence-options">
      <p>Choose consequence type:</p>
      <button type="button" data-action="take-harm" class="consequence-btn">Take Harm</button>
      <button type="button" data-action="advance-clock" class="consequence-btn">Advance Threat Clock</button>
    </div>

    <!-- Harm Table Reference -->
    <div class="harm-reference">
      <h4>Harm Consequence Reference:</h4>
      <table class="harm-table">
        <thead>
          <tr>
            <th>Pos/Eff</th>
            <th>Limited</th>
            <th>Std</th>
            <th>Great</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Control</td>
            <td>0</td>
            <td>1</td>
            <td>2</td>
          </tr>
          <tr class="{{#if (eq playerState.position 'risky')}}current-row{{/if}}">
            <td>Risky</td>
            <td>2</td>
            <td>3</td>
            <td>4</td>
          </tr>
          <tr class="{{#if (eq playerState.position 'desperate')}}current-row{{/if}}">
            <td>Desprt</td>
            <td>4</td>
            <td>5</td>
            <td>6 (DIE)</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="momentum-gain">
      üíé Momentum Gain: +{{#if (eq playerState.position "controlled")}}1{{else}}{{#if (eq playerState.position "risky")}}2{{else}}4{{/if}}{{/if}} (auto-applied)
    </div>

    <p class="protect-notice">‚ö° Teammates can <strong>[Protect]</strong> you</p>
  </div>
  {{/if}}
</div>

