<form class="{{cssClass}} flexcol" autocomplete="off">

  {{!-- Sheet Header --}}
  <header class="sheet-header">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100" />
    <div class="header-fields">
      <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="Name" /></h1>
      <div class="resource">
        <label class="allocation-label">Rally Available</label>
        <input type="checkbox" name="system.rallyAvailable" {{checked system.rallyAvailable}} {{#unless
          editable}}disabled{{/unless}} />
      </div>
    </div>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="approaches">Approaches</a>
    <a class="item" data-tab="traits">Traits</a>
    <a class="item" data-tab="harm">Harm</a>
    <a class="item" data-tab="equipment">Equipment</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Approaches Tab --}}
    <div class="tab approaches" data-group="primary" data-tab="approaches">
      <div class="approaches-header">
        <h2>Approaches</h2>
        <div class="header-buttons">
          <button class="take-action-btn draggable" type="button" draggable="true" data-action-type="take-action"
            title="Take an action (drag to hotbar to create macro)">
            <i class="fas fa-cube"></i> Take Action
          </button>
          <button class="toggle-edit-btn" type="button">
            {{#if editMode}}
            <i class="fas fa-save"></i> Save
            {{else}}
            <i class="fas fa-edit"></i> Edit
            {{/if}}
          </button>
        </div>
      </div>

      {{!-- Dot Allocation Display --}}
      <div class="dot-allocation-display">
        <div class="allocation-track">
          <span class="allocation-label">Dots:</span>
          {{#times system.totalApproachDots}}
          <span class="allocation-dot {{#if (lt this ../system.allocatedApproachDots)}}filled{{/if}}"></span>
          {{/times}}
          <span class="allocation-text">
            {{system.allocatedApproachDots}}/{{system.totalApproachDots}}
            {{#if (eq system.unallocatedApproachDots 0)}}
            <i class="fas fa-check-circle allocation-complete"></i>
            {{else}}
            ({{system.unallocatedApproachDots}} to allocate)
            {{/if}}
          </span>
        </div>
      </div>

      {{#if editMode}}
      <p class="help-text edit-mode-active">
        <i class="fas fa-edit"></i> Edit Mode Active: Click dots to allocate. Click Save when done.
      </p>
      {{else}}
      <p class="help-text">Click Edit to allocate approach dots. Maximum: 4 dots per approach.</p>
      {{/if}}

      <div class="approaches-grid">
        {{#each system.approaches}}
        <div class="approach-row">
          <label class="approach-label">
            {{approach}}
          </label>
          <div class="approach-dots" data-approach="{{approach}}">
            {{#times 4}}
            <span class="dot {{#if (lt this ../dots)}}filled{{/if}}" data-approach="{{../approach}}"
              data-value="{{add this 1}}" title="Set {{../approach}} to {{add this 1}} dots"></span>
            {{/times}}
          </div>
          <span class="approach-value">{{dots}}</span>
        </div>
        {{/each}}
      </div>

    </div>

    {{!-- Traits Tab --}}
    <div class="tab traits" data-group="primary" data-tab="traits">
      <div class="traits-header">
        <h2>Traits</h2>
        <div class="header-buttons">
          <button class="add-trait-btn" type="button">
            <i class="fas fa-plus"></i> Add Trait
          </button>
        </div>
      </div>

      <div class="traits-list">
        {{#each system.traits as |trait|}}
        <div class="trait-item {{#if trait.disabled}}disabled{{/if}}">
          <div class="trait-header">
            <h4 class="trait-name {{#if @root.editable}}editable{{/if}}" data-trait-id="{{trait.id}}"
              contenteditable="{{@root.editable}}" spellcheck="false">{{trait.name}}</h4>
            <div class="trait-header-right">
              <span class="trait-category">{{trait.category}}</span>
            </div>

            {{#if @root.editable}}
            <div class="trait-header-right">
              <button class="delete-trait-btn" type="button" data-trait-id="{{trait.id}}" title="Delete Trait">
                <i class="fas fa-trash"></i>
              </button>

            </div>
            {{/if}}
          </div>
          {{#if trait.description}}
          <p class="trait-description">{{trait.description}}</p>
          {{/if}}
        </div>
        {{/each}}
      </div>
    </div>

    {{!-- Harm Tab --}}
    <div class="tab harm" data-group="primary" data-tab="harm">
      <div class="harm-header">
        <h2>Harm Clocks</h2>
        <button class="add-harm-btn" type="button">
          <i class="fas fa-plus"></i> Take Harm
        </button>
      </div>

      <div class="harm-clocks">
        {{#each system.harmClocks as |clock|}}
        <div class="clock-item harm-clock" data-clock-id="{{clock.id}}">
          <div class="clock-header">
            <h4 class="clock-name {{#if @root.editable}}editable{{/if}}" data-clock-id="{{clock.id}}"
              contenteditable="{{@root.editable}}">{{clock.subtype}}</h4>
            {{#if @root.editable}}
            <button class="delete-clock-btn" type="button" data-clock-id="{{clock.id}}" title="Delete Clock">
              <i class="fas fa-trash"></i>
            </button>
            {{/if}}
          </div>
          <div class="clock-display">
            {{clockSVG clock width="100px" height="100px" class="harm-clock-svg"}}
          </div>
          <div class="clock-controls">
            {{#if @root.editable}}
            <input type="number" class="clock-value-input" data-clock-id="{{clock.id}}" value="{{clock.segments}}"
              min="0" max="{{clock.maxSegments}}" title="Click to edit value directly" />
            {{else}}
            <span class="clock-value">{{clock.segments}}/{{clock.maxSegments}}</span>
            {{/if}}
          </div>
        </div>
        {{/each}}

        {{#unless system.harmClocks}}
        <p class="no-clocks">No harm taken yet.</p>
        {{/unless}}
      </div>

      {{!-- Addiction Clock Section --}}
      {{#if system.addictionClock}}
      <div class="addiction-clock-section">
        <h3>ðŸ’‰ Addiction Clock</h3>
        <div class="clock-item addiction-clock" data-clock-id="{{system.addictionClock.id}}">
          <div class="clock-display">
            {{clockSVG system.addictionClock width="120px" height="120px" class="addiction-clock-svg"}}
          </div>
          <div class="clock-controls">
            {{#if @root.editable}}
            <input type="number" class="clock-value-input" data-clock-id="{{system.addictionClock.id}}"
              value="{{system.addictionClock.segments}}" min="0" max="{{system.addictionClock.maxSegments}}"
              title="Click to edit value directly" />
            {{else}}
            <span class="clock-value">{{system.addictionClock.segments}}/{{system.addictionClock.maxSegments}}</span>
            {{/if}}
          </div>
          {{#if (gte system.addictionClock.segments system.addictionClock.maxSegments)}}
          <div class="addiction-warning">
            <i class="fas fa-exclamation-triangle"></i> ADDICTED! Stims locked for entire crew.
          </div>
          {{/if}}
        </div>
      </div>
      {{/if}}
    </div>

    {{!-- Equipment Tab --}}
    <div class="tab equipment" data-group="primary" data-tab="equipment">
      <div class="equipment-header">
        <h2>Equipment</h2>
        <button class="add-equipment-btn" type="button">
          <i class="fas fa-plus"></i> Add Equipment
        </button>
      </div>

      <span class="category-badge">{{item.category}}</span>
    </div>
    </div>

    <div class="equipment-controls">
      <button class="edit-equipment-btn" type="button" data-equipment-id="{{item.id}}" title="Edit">
        <i class="fas fa-edit"></i>
      </button>
      <button class="delete-equipment-btn" type="button" data-equipment-id="{{item.id}}" title="Remove">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    </div>

    {{#if item.description}}
    <p class="equipment-description">{{item.description}}</p>
    {{/if}}

    {{#if (eq item.tier "inaccessible")}}
    <p class="equipment-note">
      <i class="fas fa-lock"></i> Requires flashback to acquire
    </p>
    {{/if}}
    </div>
    {{/each}}
    </div>
    {{else}}
    <p class="no-equipment">
      No equipment yet. Click "Add Equipment" to browse available items.
    </p>
    {{/if}}
    </div>

  </section>
</form>